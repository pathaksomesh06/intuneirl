---
title: "Reboot Chronicles: An In-depth Look at Android Mainline Updates"
date: 2023-08-12T20:14:34"
draft: false
tags: []
---

<p>In my previous blog posts, we delved deep into the intriguing topic of why an Android Enterprise device seems to have a mind of its own and reboots unexpectedly. We also ventured into the practical side of things, equipping you with the know-how to export logs, and providing a clearer lens to understand the root causes of these seemingly inexplicable reboots. However, after frequenting various online communities and forums, it came to my attention that this peculiar behavior persists for many. A number of users continue to grapple with their devices' unpredictable reboot patterns. </p><p>Today, we are going to further unravel this mystery. Leveraging Project Mainline logs, we will embark on a journey to chronologically dissect the events that lead to these soft reboots, aiming to bring clarity to this enduring Android enigma.</p><p>Before diving deep into the intricacies of Project Mainline, I recommend familiarizing yourself with my previous blog posts that delve into this mysterious reboot behavior.</p><figure class="kg-card kg-bookmark-card"><a class="kg-bookmark-container" href="__GHOST_URL__/android-enterprise-device-reboots-on-its-own/"><div class="kg-bookmark-content"><div class="kg-bookmark-title">Android Enterprise Device Reboots On Its Own!</div><div class="kg-bookmark-description">In the last few days, many people have complained about the strange behavior of their Android Enterprise Devices, wherein the user’s devices suddenly reboot on their own. I also faced the same issue with one of my customers, and it was hard to find what made the devices go</div><div class="kg-bookmark-metadata"><img class="kg-bookmark-icon" src="__GHOST_URL__/content/images/size/w256h256/2023/01/admin-ajax.png" alt=""><span class="kg-bookmark-publisher">Intune - In Real Life</span><span class="kg-bookmark-author">Somesh Pathak</span></div></div><div class="kg-bookmark-thumbnail"><img src="__GHOST_URL__/content/images/2023/04/android-icon.jpg" alt=""></div></a></figure><figure class="kg-card kg-bookmark-card"><a class="kg-bookmark-container" href="__GHOST_URL__/what-causes-an-android-device-to-reboot-on-its-own-suddenly-2/"><div class="kg-bookmark-content"><div class="kg-bookmark-title">What Causes an Android Device To Reboot On It’s Own Suddenly?</div><div class="kg-bookmark-description">In my previous post – Android Enterprise Device Reboots On Its Own!, we discussed the weird issue with Android devices rebooting randomly. However, there is more surprise; continue reading further to find the root cause for your devices going spooky! Initial Root Cause As we discussed…</div><div class="kg-bookmark-metadata"><img class="kg-bookmark-icon" src="__GHOST_URL__/content/images/size/w256h256/2023/01/admin-ajax.png" alt=""><span class="kg-bookmark-publisher">Intune - In Real Life</span><span class="kg-bookmark-author">Somesh Pathak</span></div></div><div class="kg-bookmark-thumbnail"><img src="__GHOST_URL__/content/images/wordpress/2022/08/reboot-android-device-06-1.jpg" alt=""></div></a></figure><hr><h2 id="what-is-project-mainline">What is Project Mainline?</h2><p>Android is an ever-evolving mobile operating system, and over the years, Google has introduced various mechanisms to streamline and expedite the process of delivering updates. One of the most pivotal of these mechanisms is <u>Project Mainline</u>.</p><p>Introduced with Android 10, Project Mainline enables Google to update specific internal components of the Android OS directly via the Play Store, without needing full system updates. This approach offers several benefits:</p><ol><li><strong>Speed:</strong> Updates can be rolled out faster since they bypass the traditional lengthy manufacturer and carrier validation processes.</li><li><strong>Frequency:</strong> As updates can be smaller and more targeted, users can receive them more frequently.</li><li><strong>Security:</strong> Critical security patches can be delivered promptly, ensuring devices remain secure.</li></ol><p>It is designed to distribute new Android features to users of various Android versions without requiring them to perform a complete OS update. To delve deeper into Project Mainline, let's first revisit its forerunner, '<strong><u>Project Treble</u></strong>'</p><h2 id="the-genesis-of-project-treble">The Genesis of Project Treble</h2><p>Android's extensive reach also brings with it some intricate challenges. Each manufacturer, despite rooting their systems in the AOSP source, often feels compelled to introduce their own unique alterations. This could be to ensure hardware congruence or to offer standout UI experiences and system applications. Some even delve into adjusting the system partition's contents or altering the AOSP sources directly. Such practices birthed a persistent Android challenge termed 'fragmentation'.</p><p>Fragmentation is the consequence when changes to AOSP are so profound that the universal AOSP build isn't compatible with specific devices. This places the onus on manufacturers to keep pace with AOSP updates, a daunting task considering the regular evolutionary strides Android takes annually. For end-users, this often translates to their devices becoming archaic, sometimes a mere 18 months post-purchase. Custom ROM developers often grapple with challenges, especially when they encounter unexpected hardware inconsistencies after tweaking the AOSP for specific devices. The ripple effect of this is most devices getting sporadic updates or, worse, none at all, leading to magnified security risks and delayed adoption of fresher Android versions.</p><p>Recognizing this, Google introduced "<strong>Project Treble</strong>" in Android 8.0 Oreo as a remedy. Its primary essence was rejuvenating Android's Hardware Abstraction Layer to bridge the gap between generic AOSP code and device-specific hardware. A salient aspect was drawing a clear demarcation in roles through an established partitioning blueprint:</p><ul><li>/system – Dedicated only to AOSP code, falling under Google's purview.</li><li>/vendor – Contains the Board Support Package binaries, crucial for interfacing with components like baseband, sensors, and camera. </li><li>/odm – Stores data from the "Original Device Manufacturer".</li><li>/product – Caters to device-specific changes</li></ul><p>AOSP code starts by looking for device-specific files, followed by brand-specific ones, then by the SoC, and finally resorts to its default files, which are universally compatible with all devices.</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="__GHOST_URL__/content/images/2023/08/image.png" class="kg-image" alt loading="lazy" width="591" height="423"><figcaption><a href="https://source.android.com/docs/core/ota/modular-system">Modular system components | Android Open Source Project</a></figcaption></figure><hr><h2 id="how-project-mainline-works">How Project Mainline Works?</h2><p>At its core, Project Mainline breaks down the essential components of the Android OS into distinct modules. Each module encapsulates a specific fragment of the system, paving the way for them to be updated individually without a full system overhaul.</p><p>One of the standout features of Project Mainline is the mechanism of Google Play System Updates. Gone are the days when users would be at the mercy of device manufacturers for timely system updates. Instead, with Mainline, these modular updates are funneled directly through the Google Play Store, akin to regular app updates. This not only accelerates the pace at which users receive these updates but also ensures they are consistent and regular.</p><p>Security, a cornerstone of any operating system, receives a notable boost with Mainline. By facilitating rapid deployment of security patches and other imperative updates, the window of vulnerability that often arises due to manufacturer-induced delays is considerably minimized.</p><p>A longstanding challenge that Android has grappled with is fragmentation. This refers to the disparate versions of the OS and updates across the myriad of Android devices. Furthermore, a hallmark of Project Mainline is its staunch commitment to compatibility. The modular design ensures that even if devices have divergent versions of a module, the user experience remains unaffected, with apps operating seamlessly across the board. The link below lists all the modules, their package name, formats (APK or APEX) when they were introduced, and their features:</p><figure class="kg-card kg-bookmark-card"><a class="kg-bookmark-container" href="https://source.android.com/docs/core/ota/modular-system#available-modules"><div class="kg-bookmark-content"><div class="kg-bookmark-title">Modular system components | Android Open Source Project</div><div class="kg-bookmark-description"></div><div class="kg-bookmark-metadata"><img class="kg-bookmark-icon" src="https://www.gstatic.com/devrel-devsite/prod/ve7ce216351f398481fccad3cbbc60c699e78bde8533bfe4daa150955665bb2bf/androidsource/images/favicon.png" alt=""><span class="kg-bookmark-publisher">Android Open Source Project</span></div></div><div class="kg-bookmark-thumbnail"><img src="https://source.android.com/static/docs/core/architecture/images/modular_system_components_arch.png" alt=""></div></a></figure><p>I won't delve deeply into the details of Project Mainline for this blog. Instead, we'll center our attention on the delivery process of these updates and their impact on the device.</p><h3 id="how-project-mainline-modules-are-updated">How Project Mainline Modules Are Updated</h3><p>The complex process begins with the modularization of Android. The operating system's components are compartmentalized into distinct modules, each responsible for a specific system function. These modules are either encapsulated as APKs (Java-based components) or as APEX (native components). When a particular Mainline module necessitates an update, it is meticulously packaged in its requisite format, be it APEX or APK, and subsequently propagated to devices through the Google Play Store's distribution framework.</p><p>As a workaround,  Android users are advised to go to Settings &gt; Security &gt; Google Play system update. This initiates the Mainline module update process in Google Play, enabling users to look for and install recent Mainline updates.</p><hr><h2 id="dissecting-androids-mainline-update-logs">Dissecting Android's Mainline Update Logs</h2><p>When a Google Play System Update is deployed, the device may need to reboot to accommodate new APEX or APK files. From Android 11 onwards, devices can employ "<strong>soft reboots</strong>" that refresh system elements. </p><p>Google sends Mainline module updates as bundled packages. Upon their deployment, the ModuleMetadata app's version number is updated, which informs the Google Play System Update version in device settings. For safeguarding against flawed updates, Android's RollbackManager reverts them to their previous stable versions under specific circumstances like system errors or network issues. Advanced users can leverage command-line tools to manage and inspect APEX module installations and their cryptographic validity.</p><p>Let's delve deeper and analyze the logs event-wise to provide a chronological insight into what transpired with the device.</p><figure class="kg-card kg-image-card"><img src="__GHOST_URL__/content/images/2023/08/image-1.png" class="kg-image" alt loading="lazy" width="1762" height="295" srcset="__GHOST_URL__/content/images/size/w600/2023/08/image-1.png 600w, __GHOST_URL__/content/images/size/w1000/2023/08/image-1.png 1000w, __GHOST_URL__/content/images/size/w1600/2023/08/image-1.png 1600w, __GHOST_URL__/content/images/2023/08/image-1.png 1762w" sizes="(min-width: 720px) 720px"></figure><blockquote><strong>Package Session Verification</strong>: The system is verifying a package session which often refers to the installation or update of a package.</blockquote><p>   <code>Starting preRebootVerification for session 291950126</code></p><blockquote><strong>APEX Package Information</strong>: APEX packages are used in newer versions of Android for system components. The log indicates a session associated with an APEX package related to Google's mainline module.</blockquote><p><code>Session 291950126 has following APEX packages: [com.google.mainline.primary.libs]</code></p><blockquote><strong>Broadcast Intent</strong>: A broadcast intent was sent by the system regarding a package installation.</blockquote><p><code>pkg=com.android.vending.INTENT_PACKAGE_INSTALL_COMMIT.mainline_train_primary</code></p><blockquote><strong>Shutdown Initiation</strong>: The system is initiating a shutdown with a specified reason. Here, the reason seems related to an enterprise update.</blockquote><p><code>reboot reason : enterprise,mainline_update, confirm : false</code></p><figure class="kg-card kg-image-card"><img src="__GHOST_URL__/content/images/2023/08/image-2.png" class="kg-image" alt loading="lazy" width="1762" height="147" srcset="__GHOST_URL__/content/images/size/w600/2023/08/image-2.png 600w, __GHOST_URL__/content/images/size/w1000/2023/08/image-2.png 1000w, __GHOST_URL__/content/images/size/w1600/2023/08/image-2.png 1600w, __GHOST_URL__/content/images/2023/08/image-2.png 1762w" sizes="(min-width: 720px) 720px"></figure><p>This log captures the moments just before a device reboot, initiated due to a system update or change (particularly related to mainline modules). </p><figure class="kg-card kg-image-card"><img src="__GHOST_URL__/content/images/2023/08/image-3.png" class="kg-image" alt loading="lazy" width="1730" height="44" srcset="__GHOST_URL__/content/images/size/w600/2023/08/image-3.png 600w, __GHOST_URL__/content/images/size/w1000/2023/08/image-3.png 1000w, __GHOST_URL__/content/images/size/w1600/2023/08/image-3.png 1600w, __GHOST_URL__/content/images/2023/08/image-3.png 1730w" sizes="(min-width: 720px) 720px"></figure><p>The log entry for <strong><u>Rollback</u></strong> relates to Android's <u>RollbackManager</u> and the feature in newer Android versions that allows for system updates or app updates to be rolled back to a previous version if there are issues. This is particularly useful in scenarios where an update might introduce problems or regressions and is required to revert to a more stable version.</p><p>The specific package mentioned, <strong><code>com.google.mainline.primary.libs</code></strong>, suggests this is related to Android's Mainline Modules. As mentioned earlier, Mainline Modules are a part of Android's Project Mainline and allow Google to deliver security fixes, privacy enhancements, and other improvements directly to users without needing to rely on device manufacturers to deliver a full system update.</p><p>The log entry is indicating that a rollback capability was enabled for the update of <code><strong>com.google.mainline.primary.libs</strong></code>. This means that if there's an issue with this update, the system can roll back to the previous version of this module.</p><p>At this point, it's evident that the device underwent a soft reboot. However, there's another log file that pinpoints the precise causes for such shutdowns or reboots. Let's delve into that as well.</p><h2 id="role-of-androids-power-off-reset-reasons-file">Role of Android's 'Power off Reset Reasons' File</h2><p>In Android devices, system events, errors, or unusual behaviors can generate log files for debugging and diagnostic purposes. One such file is the "<u><em>Power off reset reasons</em></u>" file. This file essentially captures the reasons or causes for unexpected power-offs or reboots that the device might have experienced.</p><p>The main purpose of this file is to aid developers, device manufacturers, and sometimes IT professionals in diagnosing why a device may have unexpectedly shut down or restarted. By understanding the root cause, they can then work towards resolving any underlying issues. The exact location of this file can vary depending on the device manufacturer and the version of Android being used. However, it's often found in the device's system logs or <code>/proc/last_kmsg</code> directory, especially if the device experienced a kernel panic.</p><p>This file is typically saved in a system directory, and accessing it might require root permissions or ADB (Android Debug Bridge). So, what does our log file say?</p><pre><code class="language-java">23/07/24 18:55:22
reason : enterprise,mainline_update
java.lang.Exception: It is not an exception!! just save the trace for process which called shutdown thread!! ShutdownThread.shutdown
	at com.android.server.power.ShutdownThread.shutdownInner(ShutdownThread.java:344)
	at com.android.server.power.ShutdownThread.reboot(ShutdownThread.java:444)
	at com.android.server.power.PowerManagerService$2.run(PowerManagerService.java:6078)
	at android.os.Handler.handleCallback(Handler.java:942)
	at android.os.Handler.dispatchMessage(Handler.java:99)
	at android.os.Looper.loopOnce(Looper.java:226)
	at android.os.Looper.loop(Looper.java:313)
	at android.os.HandlerThread.run(HandlerThread.java:67)
	at com.android.server.ServiceThread.run(ServiceThread.java:44)
	at com.android.server.UiThread.run(UiThread.java:52)
18:55:30  2023-07-24 18:55:30+0100 |  REBOOT  |       | REASON: enterprise,mainline_update
18:55:30  terminating init service start
18:55:31  terminating init service end
18:55:31  volume shutdown start
18:55:31  volume shutdown end
2023-07-24 18:57:02+0100 |    ON    | RP    |  / OFFSRC: PWRHOLD / ONSRC: ACOKB / RSTSTAT: SWRESET [72]/ apex_updated </code></pre><blockquote><strong>Reboot Reason:</strong></blockquote><p><code>reason : enterprise,mainline_update</code>: This denotes the reasons for the reboot. The term <code>enterprise</code> suggests the device is managed by an enterprise policy, indicating it's part of an organization's mobile device management system. The term <code>mainline_update</code> suggests the device is undergoing a Project Mainline update.</p><blockquote><strong>Reboot Action:</strong></blockquote><p><code>2023-07-24 18:55:30+0100 | REBOOT |...</code>: This is a timestamped record of the actual reboot action, reiterating the reasons (<code>enterprise,mainline_update</code>).</p><blockquote><strong>System Restart Info:</strong></blockquote><p><code>2023-07-24 18:57:02+0100 | ON |</code>: This timestamped entry signifies the device turned back on.  <code>RSTSTAT: SWRESET [72]</code> indicates the device underwent a software reset, and <code>apex_updated</code> confirms a Project Mainline module was updated during this reboot.</p><p>The log clearly records a deliberate system reboot, likely to apply a Project Mainline update, on an enterprise-managed Android device.</p><h2 id="why-not-confuse-it-with-the-word-enterprise-in-the-logs">Why not confuse it with the word "Enterprise" in the logs?</h2><p>The presence of the term "enterprise" in the logs is indicative of the device being managed under Android Enterprise for enhanced management and security features for Android devices in corporate environments.</p><p>When a device is enrolled in Android Enterprise through an Enterprise Mobility Management solution like Microsoft Intune, it is subject to policies and configurations set by the enterprise IT department. This includes the ability to push software updates, control the installation or removal of apps, enforce security policies, and much more.</p><h2 id="conclusion">Conclusion</h2><p>The log that I analyzed indicated a request to <code>PowerManagerService</code> to initiate a shutdown/reboot. The reason provided was, <code>enterprise,mainline_update</code>, suggesting a mainline module update. Mainline modules are a part of Android's Project Mainline, which allows core OS components to be updated via the Google Play Store (represented here by <code>com.android.vending</code>). So, the reason for the restart seems to be related to an update of a core OS component (mainline module).</p><p>Furthermore, the log for rollback manager also indicates that a rollback capability was enabled for the update of <code>com.google.mainline.primary.libs</code>. In the context of device restart behavior, it seems that the device has been initiating an update related to Project Mainline and went through a soft reboot.</p><p>However, it's essential to note that such mechanisms are designed with user security and device stability in mind. These reboots ensure that the device runs the most recent and secure software modules.</p><p>I trust this article has shed light on the mechanics behind updates and offered a clearer understanding of the log processes. If you found this information valuable, please consider sharing the post. Should you have any questions or need further clarification, don't hesitate to reach out!</p><hr>